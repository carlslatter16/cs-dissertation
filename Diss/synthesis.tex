%!TeX root=Dissertation.tex

\chapter{Threat tool development}
\section{Language Choice}
Planning was essential to the tool development process. Any program needs a problem(s) to solve represented by a set of requirements, a flow diagram to roughly represent the algorithm path in pseudo code and a language of choice.
Langauges are suited for different purposes. The two used primarily in this project was c(++?) and python3. 

Python is a psuedo C translated langauge that in considered to be higher level in abstraction, it hides some of the complexity which can allow for 
more elaborate logic. Python3 is the newer itteration which comes with slight langauge changes and improvments, with some libraries being exclusive to the newer version. It is preferble and sensible to keep software up to date, and to reinforce update culture and so it is important to do so here too.

C is the lanaguage that some others are built on, python uses some C libraries in the background with a nice wrapper. The advantage of C is the freedom of memory access which can be useful for finer tuned programming. The problem dictates the language, threat tools that aren't buffer overflow based are usually suited to python3.
They are compact, easier to understand and has well documented libraries. If the memory access or speed is not needed, then python3 is preferble. For detection tools that scale up, C is preferable as python conveniences stack up and become efficency hinderances. These hinderances can undermine the goal of the program in the first place, in which case a C variant is preferble.

\section{Python Libraries & Methods}
\subsection{Notable code credit}
\begin{enumerate}
    \item https://pypi.org/project/pycryptodome/
    \item https://docs.python.org/3/library/argparse.html
    \item https://gist.github.com/mrpapercut/92422ecf06b5ab8e64e502da5e33b9f7
    \item https://docs.python.org/3/library/base64.html
\end{enumerate}
%more sections

\section{Logic Explanation}
The python3 DNS exifltrator is a tool to generate UDP DNS traffic over to the specified port and IP. It makes use of the above project that simply sends a UDP packet. I modified the code and adjusted it to have a variable subdomain name appended to a dunny domain.
This string is generated by taking an input and producting an output based on the paramters specified at the command line. 

By default, a script defined string will be spent to a script defined address via Base64 encoding, to obfuscate to a basic level. The whole URL is created,
for example "U3VwZXIgc2VjcmV0IGRhdGE=.cyblogia.com". 

The string is then pushed over the network as an A record, with the DNS server logging failed resolutions. This assumes DNS server control somewhere down the pipeline but allows for covert tranmission if monitoring is not present.
Base64 is encoding, not encryption. 

A network engineer who recognises the regular "==" may regognise the encoding algorithm in use. Since the project is to illustrate "cat and mouse behavior", AES encryption was impleemted in CBC mode which takes a key and IV and encrypts the data into byte output.
Both the IV and key is required for decryption and means the later encoded base64 string, would not produce clear text after analysis. 

If the code in question is found, then the key would still be needed. Only the IV is in clear text inside the malware for proof of concept, however command history would be required to obtain the key needed that is passed as an argument as of present. 
Actual malware implementation would likely do these function internally. 

%explain aes more

This tool can produce obfuscated exfiltration via DNS from a given input. Extra functionality has been implementated to produce this effect for any given input length by splitting up files line by line and running the above process on each line. This means that whole files can be sent over the network via subdomain naming. This is not designed for speed. rather covertness of content. 
In experimentation, it took 2-3 minuites reiably for a 19kb file. 

Input length is irrevant for encruyption due to my implementation of manually splitting and padding of lines needed to fuffil AES requirements. This is rather loud on the network - if encrypted the contents cannot be feasibly parsed, but the process causes many requests to be produced so sysadmins may gain overall suspicion.
This could be mitigated with rate limiting. If manual detection is not a concerna and tailored detection is not in place, then default functionality can be leverage to exploit a lack of intrusion prevention to exifltrate data out of infrastructure in a "noisy" way.

%talk detection - rates, lots of server failures, base dns lookup?, 

\chapter{Discussion of the secure malware analysis lab}
\section{Hardware Choice}
Malware and threat analysis can be dangerous and so it is important to have an isolated lab. For this project, I did not feel that a standard virtual machine would suffice. While I do not believe that any of the samples or attacks can escape the hypervisor jail, I do not want to take the risk when this is ran on my own infrastructure. 
I purchased an isolated Dell Optiplex 7010 for a few reasons: 
\begin{enumerate}
    \item Price - It costed me Â£90 which was a cost that minimized the complexity of using external infrastructure
    \item CPU - It has an i5 3470, a quad core at 3.2GHz should be able to cope with a few minimal instances
    \item Memory - The main incentive of this system - 24GB of DDR3 memory which is enough to distribute to all the systems that need it and to bypass low memory VM malware checks
    \item Storage - A 160GB HDD is sufficient for this project, I have reserve storage should it be required.
\end{enumerate}

\section{OS Choice}
In regards to the host operating system, there is a lot of choice. I decided to use a host OS and then a hypervisor to add an extra layer that would need to be compromised. Operating systems are often in actuality distributions of the same underlying source code. There are two main ones, windows and unix. Unix is ideal in this situation as the general userbase trends to the windows side. Malware prefers to target the largest userbase and as a result, most malware is for Windows.

This is security by obsecurity as unix configured properly versus windows configured properly are relatively equal, something that is not a replacement for security steps, but in addition to. Malware can be on any platform, but by using a unix distribution as the host, with a windows VM, there are more variables that a given piece of malware would have to adapt to. Unix also has the advantage of being open soruce which allows for anyone to review the code and find vulnerabilities.

I picked ZorinOS which is Debian based and is targeted to run well on older hardware. It recieves regular security updates and is widely regarded to be an improvement from Ubuntu in just about every category aside from documentation.

The hypervisor will run as a meditary between the host and each VM. In regards to vulnerable machines, Windows10 and Windows7 are the prime cantidates due to the large volume of malware dedicated to those architectures. For the former, it is likely that Windows Defender would need to be disabled for some experimentation. Malware sometimes has it's stager blocked by AV systems, but the actual payload can be ran.

\section{Hypervisor Choice}
I decided on VMware Workstation Pro 2016. I already had licensing for it and have found it to be easier to migrate to another system should the need arise. As of writing, 16 is up to date and has all the relevant security patches. It runs on zorin OS well, and allows for additional operating systems to be utlilized called virtual machines.
These are isolated systems that contain the OS material inside and any processes tied to it. Usually, an application cannot disern any difference and will run as normal under VM environments. I have had to take a few additonal steps to improve secruity of which VMware allows.

VMWare tools is a package which allows for better interaction between host and VM - often in the form of shared clipboards, folders and keyboard inputs. This however would never be installed on any non-VM environment and as a result, creates an obvious indicator of VM use which may prevent malware from running and consequenially behavioural analysis cannot take place. This will be disabled as the negatives do not outweigh the benefits.

VMWare workstation has the benefit of having virtual network capability which means that different VM isntances can be psudo cabled together for communication which is key to malware pivoting. This is in place for all VMs required, with strict restrictions on access to the host system.

%do I need to talk about what VMs I will have?

\section{Software Choice}
\subsection{REMnux}
REMnux is a malware analysis focused gateway virtual machine that is debian based. It comes in a distribution, package suite and also as a docker image. The former was chosen for simplicity and the fact that VMWare was already setup. The concept of this implementation is to
forward all traffic from every VM to analyse using the suite of tools installed. Some of these individual tools are discussed below.
\subsection{InetSim}
InetSim is a package that I isntalled on the REMnux virtual machine that will act as a DNS server that resonds to every domain with the same webpage - a sample web page. This means that a DNS http or icmp request would resolve correctly, and assuming there is no in-depth responce checking, malware web checks will resovle correctly. 
This is nessesary because there are malware samples that do check connectivity to avoid an isolated analysis environment such as this implementation.
\subsection{FlareVM} 
FlareVM is another choice that offers a hybrid between the REMNux gateway and vulnerable machine setup. It provides tools inside the vulnerable macbine to conduct behavioural analysis in real time such as regsitry change and file system alteration monitoring. Additionally fakenet is installed which is another DNS spoofing tool. Having multiple options in experimentation like that of this project is important for consistency and reliability. 
\subsection{ParrotOS}
ParrotOS is a security focussed debian linux based operating system that acts as a collation of the most used cybersecurity tools. It is similar to Offensive Security's Kali Linux which offers much of the same functionality, and is largely preference. This VM will act as a way of deploying manaul security testing to the vulnerable machine should it be needed. The OS itself is well recognised as being secure itself, with many using the desktop variant as a home system. The security variant comes with the tools needed as as such, is likely the one that will be in use.

%extra tools? the windows file one

\section{Additional Security Choices}
Measures must be taken for security, according to risk. The host will be disconnected from the internet at all points of malware analysis via a lack of cable/wireless interface. An intranet network is created for the virtual lab communication that is nessesary for malware functionality.

It is important for the malware host to be updated over time; with additional tools, samples and security updates, meaning a delivery mechanism is nessesary. The medium chosen is a dedicated usb drive that is plugged in for deliverables. The drive is formatted on the lab host after use so that 
any payloads via infection are wiped before exposure to real infrastructure. 

There is risk in this, notably the implantation of malware in USB controller firmware but it is the only feasible way to deliver material which is essential for maintaining the lab. These risks are managed via defence in depth at every step.


%not on internet etc.. no cable or interface

\section{Sample Choice}
The only samples that will be used are those that are compressed with the "infected" password. This prevents accidental activation and the name structure means that a given hash can be cross referenced with existing research material of that sample. 
Samples are obtained from well known and trusted github reposititoies, with those from 'theZoo' being the most widely used with the same reflecting in the project.

\begin{enumerate}
    \item https://github.com/ytisf/theZoo
    \item https://github.com/fabrimagic72/malware-samples
    \item https://github.com/mstfknn/malware-sample-library
    \item https://github.com/RamadhanAmizudin/malware
\end{enumerate}

\chapter{Investigate antivirus systems w/ comparison}

%fix wierd quote marks


\chapter{Investigate IDS/IPS systems w/ comparison}


\chapter{Illustrate proof of concept IDS \& implementation of technologies}

